#!/usr/bin/env bash

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
# shellcheck source=lib/config.sh
source "$SCRIPT_DIR/lib/config.sh"

USE_BEADS=0
SETUP_CLAUDE=0
SETUP_CODEX=0
YOLO=0
STEALTH=0
PROJECT_ARG=""

declare -A CREATED_TOP_LEVEL=()

print_help() {
  cat <<'EOF'
Usage: ralph init [OPTIONS]

Initialize Ralph in a project using the V2 `.ralph/` layout.

Options:
  --project <path>  Initialize the target project path (defaults to current directory)
  --stealth         Add folders created by this run to .git/info/exclude
  --codex           Set up .codex/commands/ symlinks to Ralph prompts
  --beads           Run `bd init` and use .example.beads.md prompt templates when available
  --claude          Set up .claude/commands/ symlinks to Ralph prompts
  -y, --yolo        Accepted for compatibility; has no effect in deterministic init
  -h, --help        Show this help message

Examples:
  ralph init
  ralph init --project ../my-project --stealth --claude
  ralph init --beads --codex
EOF
}

fail() {
  echo "Error: $1" >&2
  exit 1
}

warn() {
  echo "Warning: $1" >&2
}

mark_top_level_created() {
  local rel_dir="$1"
  CREATED_TOP_LEVEL["$rel_dir"]=1
}

ensure_top_level_dir() {
  local rel_dir="$1"
  local abs_dir="$PROJECT_ROOT/$rel_dir"
  if [[ ! -d "$abs_dir" ]]; then
    mkdir -p "$abs_dir"
    mark_top_level_created "$rel_dir"
  fi
}

copy_prompt_templates() {
  local prompt_name=""
  local template_path=""
  local prompt_dest=""

  for prompt_name in design plan execute handoff prepare blocked; do
    template_path="$SCRIPT_DIR/prompts/${prompt_name}.example.md"
    if [[ "$USE_BEADS" == "1" ]] && [[ -f "$SCRIPT_DIR/prompts/${prompt_name}.example.beads.md" ]]; then
      template_path="$SCRIPT_DIR/prompts/${prompt_name}.example.beads.md"
    fi

    prompt_dest="$PROJECT_ROOT/.ralph/prompts/${prompt_name}.md"
    if [[ -e "$prompt_dest" ]]; then
      continue
    fi
    cp "$template_path" "$prompt_dest"
  done
}

setup_commands_symlinks() {
  local tool_dir="$1"
  local rel_prompt_prefix="../../.ralph/prompts"
  local commands_dir="$PROJECT_ROOT/$tool_dir/commands"
  local prompt_name=""

  ensure_top_level_dir "$tool_dir"
  mkdir -p "$commands_dir"

  for prompt_name in design plan execute handoff prepare; do
    ln -sf "$rel_prompt_prefix/${prompt_name}.md" "$commands_dir/${prompt_name}.md"
  done
}

run_beads_init() {
  local beads_dir="$PROJECT_ROOT/.beads"

  if [[ -d "$beads_dir" ]]; then
    return 0
  fi

  if ! command -v bd >/dev/null 2>&1; then
    fail "--beads was set but 'bd' was not found in PATH"
  fi

  (
    cd "$PROJECT_ROOT"
    bd init
  )

  if [[ -d "$beads_dir" ]]; then
    mark_top_level_created ".beads"
  fi
}

add_stealth_excludes() {
  local created_entries=()
  local rel_dir=""
  local git_exclude_path=""

  for rel_dir in .ralph .beads .codex .claude; do
    if [[ "${CREATED_TOP_LEVEL[$rel_dir]:-0}" == "1" ]]; then
      created_entries+=("${rel_dir}/")
    fi
  done

  if [[ "${#created_entries[@]}" -eq 0 ]]; then
    return 0
  fi

  if ! command -v git >/dev/null 2>&1; then
    warn "--stealth was requested, but git is not available; skipping .git/info/exclude updates"
    return 0
  fi

  if ! git -C "$PROJECT_ROOT" rev-parse --is-inside-work-tree >/dev/null 2>&1; then
    warn "--stealth was requested, but '$PROJECT_ROOT' is not inside a git work tree; skipping .git/info/exclude updates"
    return 0
  fi

  git_exclude_path="$(git -C "$PROJECT_ROOT" rev-parse --path-format=absolute --git-path info/exclude 2>/dev/null || true)"
  if [[ -z "$git_exclude_path" ]]; then
    warn "--stealth was requested, but .git/info/exclude could not be resolved; skipping exclude updates"
    return 0
  fi

  mkdir -p "$(dirname "$git_exclude_path")"
  touch "$git_exclude_path"

  for rel_dir in "${created_entries[@]}"; do
    if ! grep -Fqx "$rel_dir" "$git_exclude_path"; then
      printf '%s\n' "$rel_dir" >> "$git_exclude_path"
    fi
  done
}

while [[ $# -gt 0 ]]; do
  case "$1" in
    --project)
      if [[ $# -lt 2 || -z "${2:-}" ]]; then
        echo "Error: --project requires a path argument" >&2
        exit 2
      fi
      PROJECT_ARG="$2"
      shift 2
      ;;
    --project=*)
      PROJECT_ARG="${1#*=}"
      if [[ -z "$PROJECT_ARG" ]]; then
        echo "Error: --project requires a path argument" >&2
        exit 2
      fi
      shift
      ;;
    --stealth)
      STEALTH=1
      shift
      ;;
    --codex)
      SETUP_CODEX=1
      shift
      ;;
    --beads)
      USE_BEADS=1
      shift
      ;;
    --claude)
      SETUP_CLAUDE=1
      shift
      ;;
    -y|--yolo)
      YOLO=1
      shift
      ;;
    -h|--help)
      print_help
      exit 0
      ;;
    *)
      echo "Error: Unknown option: $1" >&2
      echo "Run 'ralph init --help' for usage information" >&2
      exit 2
      ;;
  esac
done

PROJECT_ROOT="$(ralph_resolve_project_root "${PROJECT_ARG:-$(pwd)}")"
if [[ -e "$PROJECT_ROOT" && ! -d "$PROJECT_ROOT" ]]; then
  fail "--project path exists but is not a directory: $PROJECT_ROOT"
fi
mkdir -p "$PROJECT_ROOT"

ralph_load_config "$PROJECT_ROOT"

if [[ "$YOLO" == "1" ]]; then
  warn "--yolo has no effect for deterministic 'ralph init'"
fi

ensure_top_level_dir ".ralph"
mkdir -p "$PROJECT_ROOT/.ralph/prompts" "$PROJECT_ROOT/.ralph/plans" "$PROJECT_ROOT/.ralph/logs"

cp "$SCRIPT_DIR/.env.example" "$PROJECT_ROOT/.ralph/.env.example"
copy_prompt_templates

if [[ "$USE_BEADS" == "1" ]]; then
  run_beads_init
fi

if [[ "$SETUP_CLAUDE" == "1" ]]; then
  setup_commands_symlinks ".claude"
fi

if [[ "$SETUP_CODEX" == "1" ]]; then
  setup_commands_symlinks ".codex"
fi

if [[ "$STEALTH" == "1" ]]; then
  add_stealth_excludes
fi

echo "Initialized Ralph project layout at: $PROJECT_ROOT"
